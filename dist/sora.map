{"version":3,"sources":["utils.ts","connection/base.ts","connection/publisher.ts","connection/subscriber.ts","sora.ts"],"names":[],"mappings":"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","file":"sora.map","sourceRoot":"../src","sourcesContent":["export function trace(clientId: string | null, title: string, value: Object | string) {\n  let prefix = '';\n  if (window.performance) {\n    prefix = '[' + (window.performance.now() / 1000).toFixed(3) + ']';\n  }\n  if (clientId) {\n    prefix = prefix + '[' + clientId + ']';\n  }\n\n  if (isEdge()) {\n    console.log(prefix + ' ' + title + '\\n', value); // eslint-disable-line\n  }\n  else {\n    console.info(prefix + ' ' + title + '\\n', value); // eslint-disable-line\n  }\n}\n\nfunction browser() {\n  const ua = window.navigator.userAgent.toLocaleLowerCase();\n  if (ua.indexOf('edge') !== -1) {\n    return 'edge';\n  }\n  else if (ua.indexOf('chrome')  !== -1 && ua.indexOf('edge') === -1) {\n    return 'chrome';\n  }\n  else if (ua.indexOf('safari')  !== -1 && ua.indexOf('chrome') === -1) {\n    return 'safari';\n  }\n  else if (ua.indexOf('opera')   !== -1) {\n    return 'opera';\n  }\n  else if (ua.indexOf('firefox') !== -1) {\n    return 'firefox';\n  }\n  return ;\n}\n\nfunction isPlanB() {\n  return browser() === 'chrome' || browser() === 'safari';\n}\n\nexport function isUnifiedChrome() {\n  if (browser() !== 'chrome') {\n    return false;\n  }\n  const ua = window.navigator.userAgent.toLocaleLowerCase();\n  const splitedUserAgent = /chrome\\/([\\d.]+)/.exec(ua);\n  if (!splitedUserAgent || splitedUserAgent.length < 2) {\n    return false;\n  }\n  return 71 <= parseInt(splitedUserAgent[1]);\n}\n\nexport function isUnifiedSafari() {\n  if (!isSafari()) {\n    return false;\n  }\n  const appVersion = window.navigator.appVersion.toLowerCase();\n  const version = /version\\/([\\d.]+)/.exec(appVersion)!.pop()!;\n  return 12.0 < parseFloat(version);\n}\n\nexport function isEdge() {\n  return browser() === 'edge';\n}\n\nexport function isSafari() {\n  return browser() === 'safari';\n}\n\nexport function isChrome() {\n  return browser() === 'chrome';\n}\n\nexport function replaceAnswerSdp(sdp: string) {\n  let ssrcPattern: RegExp | string = new RegExp(/m=video[\\s\\S]*?(a=ssrc:(\\d+)\\scname:.+\\r\\n(a=ssrc:\\2\\smsid:.+\\r\\na=ssrc:\\2\\smslabel:.+\\r\\na=ssrc:\\2\\slabel:.+\\r\\n)?)/);  // eslint-disable-line\n  const found = sdp.match(ssrcPattern);\n  if (!found) {\n    return sdp;\n  }\n\n  const ssrcAttributes = found[1];\n  ssrcPattern = found[1];\n  const ssrcId = parseInt(found[2]);\n  const ssrcIdPattern = new RegExp(ssrcId.toString(), 'g');\n  const ssrcGroup = ['a=ssrc-group:SIM'];\n  const ssrcAttributeList = [];\n  for (let i = 0; i < 3; i += 1) {\n    ssrcGroup.push((ssrcId + i).toString());\n    ssrcAttributeList.push(ssrcAttributes.replace(ssrcIdPattern, (ssrcId + i).toString()));\n  }\n  return sdp.replace(ssrcPattern, [ssrcGroup.join(' '), '\\r\\n', ssrcAttributeList.join('')].join(''));\n}\n\ninterface AudioVisualData {\n  codec_type?: never;\n  bit_rate?: never;\n}\n\ninterface SignalingMessage {\n  type: 'connect';\n  role: never;\n  channel_id: never;\n  metadata: never;\n  sdp: string;\n  userAgent: string;\n  audio: boolean | AudioVisualData;\n  video: boolean | AudioVisualData;\n  multistream?: boolean;\n  plan_b?: boolean;\n  spotlight?: never;\n  simulcast?: boolean | { quality: never };\n}\n\nexport function createSignalingMessage(offerSDP: string, role, channelId, metadata, options) {\n  const message: SignalingMessage = {\n    type: 'connect',\n    role: role,\n    channel_id: channelId,\n    metadata: metadata,\n    sdp: offerSDP,\n    userAgent: window.navigator.userAgent,\n    audio: true,\n    video: true\n  };\n  Object.keys(message).forEach(key => {\n    if (message[key] === undefined) {\n      message[key] = null;\n    }\n  });\n  if ('multistream' in options && options.multistream === true) {\n    // multistream\n    message.multistream = true;\n    if (!isUnifiedChrome() && !isUnifiedSafari() && isPlanB()) {\n      message.plan_b = true;\n    }\n    // spotlight\n    if ('spotlight' in options) {\n      message.spotlight = options.spotlight;\n    }\n  } else if ('simulcast' in options || 'simulcastQuality' in options) {\n    if (!(isUnifiedSafari() || isChrome())) {\n      throw new Error('Simulcast can not be used with this browse be used with this browserr');\n    }\n    // simulcast\n    if ('simulcast' in options && options.simulcast === true) {\n      message.simulcast = true;\n    }\n    const simalcastQualities = ['low', 'middle', 'high'];\n    if ('simulcastQuality' in options && 0 <= simalcastQualities.indexOf(options.simulcastQuality)) {\n      message.simulcast = {\n        quality: options.simulcastQuality\n      };\n    }\n  }\n  // parse options\n  const audioPropertyKeys = ['audioCodecType', 'audioBitRate'];\n  const videoPropertyKeys = ['videoCodecType', 'videoBitRate'];\n  const copyOptions = Object.assign({}, options);\n  Object.keys(copyOptions).forEach(key => {\n    if (key === 'audio' && typeof copyOptions[key] === 'boolean') return;\n    if (key === 'video' && typeof copyOptions[key] === 'boolean') return;\n    if (0 <= audioPropertyKeys.indexOf(key) && copyOptions[key] !== null) return;\n    if (0 <= videoPropertyKeys.indexOf(key) && copyOptions[key] !== null) return;\n    delete copyOptions[key];\n  });\n\n  if ('audio' in copyOptions) {\n    message.audio = copyOptions.audio;\n  }\n  const hasAudioProperty = Object.keys(copyOptions).some(key => {\n    return 0 <= audioPropertyKeys.indexOf(key);\n  });\n  if (message.audio && hasAudioProperty) {\n    message.audio = {};\n    if ('audioCodecType' in copyOptions) {\n      message.audio['codec_type'] = copyOptions.audioCodecType;\n    }\n    if ('audioBitRate' in copyOptions) {\n      message.audio['bit_rate'] = copyOptions.audioBitRate;\n    }\n  }\n\n  if ('video' in copyOptions) {\n    message.video = copyOptions.video;\n  }\n  const hasVideoProperty = Object.keys(copyOptions).some(key => {\n    return 0 <= videoPropertyKeys.indexOf(key);\n  });\n  if (message.video && hasVideoProperty) {\n    message.video = {};\n    if ('videoCodecType' in copyOptions) {\n      message.video['codec_type'] = copyOptions.videoCodecType;\n    }\n    if ('videoBitRate' in copyOptions) {\n      message.video['bit_rate'] = copyOptions.videoBitRate;\n    }\n  }\n\n  return message;\n}\n","export type ConnectionOptions = {\n  audio?: boolean,\n  audioCodecType?: string,\n  audioBitRate?: number,\n  video?: boolean,\n  videoCodecType?: string,\n  videoBitRate?: number,\n  multistream?: boolean,\n  spotlight?: number,\n  simulcast?: boolean,\n  simulcastQuality?: 'low' | 'middle' | 'high'\n}\n\nimport { createSignalingMessage, trace, isSafari, isUnifiedChrome, replaceAnswerSdp } from '../utils';\n\nexport type ConnectionCallbacks = {\n  disconnect: (event: CloseEvent) => void;\n  push: (data: any) => void;\n  addstream: () => void;\n  removestream: () => void;\n  notify: (data: any) => void;\n  log: (title: string, message: Object | string) => void;\n}\ninterface RTCIceCandidateInitMessage extends RTCIceCandidateInit {\n  type?: 'candidate';\n}\n\nabstract class ConnectionBase {\n  channelId: string;\n  metadata: string;\n  signalingUrl: string;\n  options: ConnectionOptions;\n  debug: boolean;\n  clientId: string | null;\n  remoteClientIds: string[];\n  stream: MediaStream | null;\n  role: string | null;\n  authMetadata: string | null;\n  protected ws: WebSocket | null;\n  protected pc: RTCPeerConnection | null;\n  protected callbacks: ConnectionCallbacks\n\n  constructor(signalingUrl: string, channelId: string, metadata: string, options: ConnectionOptions, debug: boolean) {\n    this.channelId = channelId;\n    this.metadata = metadata;\n    this.signalingUrl = signalingUrl;\n    this.options = options;\n    this.debug = debug;\n    this.clientId = null;\n    this.remoteClientIds = [];\n    this.stream = null;\n    this.role = null;\n    this.ws = null;\n    this.pc = null;\n    this.callbacks = {\n      disconnect: function() {},\n      push: function() {},\n      addstream: function() {},\n      removestream: function() {},\n      notify: function() {},\n      log: function() {}\n    };\n    this.authMetadata = null;\n  }\n\n  on(kind: keyof ConnectionCallbacks, callback: () => void) {\n    if (kind in this.callbacks) {\n      this.callbacks[kind] = callback;\n    }\n  }\n\n  disconnect = () => {\n    this.clientId = null;\n    this.authMetadata = null;\n    this.remoteClientIds = [];\n    const closeStream = new Promise((resolve, _) => {\n      if (!this.stream) return resolve();\n      this.stream.getTracks().forEach((t) => {\n        t.stop();\n      });\n      this.stream = null;\n      return resolve();\n    });\n    const closeWebSocket = new Promise((resolve, reject) => {\n      if (!this.ws) return resolve();\n      this.ws.onclose = () => {};\n\n      let counter = 5;\n      const timer_id = setInterval(() => {\n        if (!this.ws) {\n          clearInterval(timer_id);\n          return reject('WebSocket Closing Error');\n        }\n        if (this.ws.readyState === 3) {\n          this.ws = null;\n          clearInterval(timer_id);\n          return resolve();\n        }\n        --counter;\n        if (counter < 0) {\n          clearInterval(timer_id);\n          return reject('WebSocket Closing Error');\n        }\n      }, 1000);\n      this.ws.close();\n    });\n    const closePeerConnection = new Promise((resolve, reject) => {\n      // Safari は signalingState が常に stable のため個別に処理する\n      if (isSafari() && this.pc) {\n        this.pc.oniceconnectionstatechange = null;\n        this.pc.close();\n        this.pc = null;\n        return resolve();\n      }\n      if (!this.pc || this.pc.signalingState === 'closed') return resolve();\n\n      let counter = 5;\n      const timer_id = setInterval(() =>{\n        if (!this.pc) {\n          clearInterval(timer_id);\n          return reject('PeerConnection Closing Error');\n        }\n        if (this.pc.signalingState === 'closed') {\n          clearInterval(timer_id);\n          this.pc.oniceconnectionstatechange = null;\n          this.pc = null;\n          return resolve();\n        }\n        --counter;\n        if (counter < 0) {\n          clearInterval(timer_id);\n          return reject('PeerConnection Closing Error');\n        }\n      }, 1000);\n      this.pc.close();\n    });\n    return Promise.all([closeStream, closeWebSocket, closePeerConnection]);\n  }\n\n  protected signaling(offer: {type: 'offer', sdp: string}) {\n    this.trace('CREATE OFFER SDP', offer);\n    return new Promise((resolve, reject) => {\n      const signalingMessage = createSignalingMessage(\n        offer.sdp, this.role, this.channelId, this.metadata, this.options);\n      if (this.ws === null) {\n        this.ws = new WebSocket(this.signalingUrl);\n      }\n      this.ws.onclose = (e) => {\n        reject(e);\n      };\n      this.ws.onopen = () => {\n        this.trace('SIGNALING CONNECT MESSAGE', signalingMessage);\n        this.ws!.send(JSON.stringify(signalingMessage));\n      };\n      this.ws.onmessage = (event) => {\n        const data = JSON.parse(event.data);\n        if (data.type == 'offer') {\n          this.clientId = data.client_id;\n          this.ws!.onclose = (e) => {\n            this.disconnect()\n              .then(() => {\n                this.callbacks.disconnect(e);\n              });\n          };\n          this.ws!.onerror = null;\n          if ('metadata' in data) {\n            this.authMetadata = data.metadata;\n          }\n          this.trace('SIGNALING OFFER MESSAGE', data);\n          this.trace('OFFER SDP', data.sdp);\n          resolve(data);\n        } else if (data.type == 'update') {\n          this.trace('UPDATE SDP', data.sdp);\n          this.update(data);\n        } else if (data.type == 'ping') {\n          this.ws!.send(JSON.stringify({ type: 'pong' }));\n        } else if (data.type == 'push') {\n          this.callbacks.push(data);\n        } else if (data.type == 'notify') {\n          this.callbacks.notify(data);\n        }\n      };\n    });\n  }\n\n  protected async createOffer() {\n    interface Config {\n      iceServers: never[];\n      sdpSemantics?: 'unified-plan';\n    }\n    let config: Config = { iceServers: [] };\n    if (isUnifiedChrome()) {\n      config = {...config, sdpSemantics: 'unified-plan'};\n    }\n    const pc = new RTCPeerConnection(config);\n    if (isSafari()) {\n      pc.addTransceiver('video').direction = 'recvonly';\n      pc.addTransceiver('audio').direction = 'recvonly';\n      const offer = await pc.createOffer();\n      pc.close();\n      return Promise.resolve(offer);\n    }\n    const offer_1 = await pc.createOffer({ offerToReceiveAudio: true, offerToReceiveVideo: true });\n    pc.close();\n    return Promise.resolve(offer_1);\n  }\n\n  protected async connectPeerConnection(_message: {\n    config?: RTCConfiguration;\n  }) {\n    interface Config extends RTCConfiguration {\n      sdpSemantics?: 'unified-plan';\n    }\n    interface Message {\n      config?: Config;\n    }\n    const message: Message = { ..._message };\n    if (!message.config) {\n      message.config = {};\n    }\n    if (RTCPeerConnection.generateCertificate === undefined) {\n      if (isUnifiedChrome()) {\n        message.config = {...message.config, sdpSemantics: 'unified-plan'};\n      }\n      this.trace('PEER CONNECTION CONFIG', message.config);\n      this.pc = new RTCPeerConnection(message.config);\n      this.pc.oniceconnectionstatechange = (_) => {\n        this.trace('ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE',this.pc!.iceConnectionState);\n      };\n      return Promise.resolve(message);\n    }\n    else {\n      const certificate = await RTCPeerConnection.generateCertificate({ name: 'ECDSA', namedCurve: 'P-256' });\n      message.config.certificates = [certificate];\n      if (isUnifiedChrome()) {\n        message.config = { ...message.config, sdpSemantics: 'unified-plan' };\n      }\n      this.trace('PEER CONNECTION CONFIG', message.config);\n      this.pc = new RTCPeerConnection(message.config);\n      this.pc.oniceconnectionstatechange = (_) => {\n        this.trace('ONICECONNECTIONSTATECHANGE ICECONNECTIONSTATE', this.pc!.iceConnectionState);\n      };\n      return message;\n    }\n  }\n\n  protected setRemoteDescription(message: never) {\n    return this.pc!.setRemoteDescription(new RTCSessionDescription({ type: 'offer', sdp: message.sdp }));\n  }\n\n  protected createAnswer = async () => {\n    const sessionDescription = await this.pc!.createAnswer();\n    if (this.options.simulcast) {\n      sessionDescription.sdp = replaceAnswerSdp(sessionDescription.sdp!);\n    }\n    return this.pc!.setLocalDescription(sessionDescription);\n  }\n\n  protected sendAnswer() {\n    this.trace('ANSWER SDP', this.pc!.localDescription!.sdp);\n    this.ws!.send(JSON.stringify({ type: 'answer', sdp: this.pc!.localDescription!.sdp }));\n    return;\n  }\n\n  protected sendUpdateAnswer = () => {\n    this.trace('ANSWER SDP', this.pc!.localDescription!.sdp);\n    this.ws!.send(JSON.stringify({ type: 'update', sdp: this.pc!.localDescription!.sdp }));\n    return;\n  }\n\n  protected onIceCandidate() {\n    return new Promise((resolve, reject) => {\n      const timerId = setInterval(() => {\n        if (this.pc === null) {\n          clearInterval(timerId);\n          const error = new Error();\n          error.message = 'ICECANDIDATE TIMEOUT';\n          reject(error);\n        }\n        else if (this.pc && this.pc.iceConnectionState === 'connected') {\n          clearInterval(timerId);\n          resolve();\n        }\n      }, 100);\n      this.pc!.onicecandidate = event => {\n        this.trace('ONICECANDIDATE ICEGATHERINGSTATE', this.pc!.iceGatheringState);\n        if (event.candidate === null) {\n          clearInterval(timerId);\n          resolve();\n        }\n        else {\n          const message: RTCIceCandidateInitMessage = event.candidate.toJSON();\n          message.type = 'candidate';\n          this.trace('ONICECANDIDATE CANDIDATE MESSAGE', message);\n          this.ws!.send(JSON.stringify(message));\n        }\n      };\n    });\n  }\n \n  protected update(message: never) {\n    return this.setRemoteDescription(message);\n  }\n\n  protected trace(title: string, message: Object | string) {\n    this.callbacks.log(title, message);\n    if (!this.debug) { return; }\n    trace(this.clientId, title, message);\n  }\n}\n\nexport default ConnectionBase;\n","import ConnectionBase from './base';\n\nclass ConnectionPublisher extends ConnectionBase {\n  connect(stream: MediaStream | null) {\n    this.role = 'upstream';\n    if (this.options && this.options.multistream) {\n      return this.multiStream(stream);\n    }\n    else {\n      return this.singleStream(stream);\n    }\n  }\n\n  private singleStream(stream: MediaStream | null) {\n    return this.disconnect()\n      .then(this.createOffer)\n      .then(this.signaling)\n      .then(this.connectPeerConnection)\n      .then(message => {\n        if (typeof this.pc.addStream === 'undefined') {\n          stream.getTracks().forEach(track => {\n            this.pc.addTrack(track, stream);\n          });\n        }\n        else {\n          this.pc!.addStream(stream);\n        }\n        this.stream = stream;\n        return this.setRemoteDescription(message);\n      })\n      .then(this.createAnswer)\n      .then(this.sendAnswer)\n      .then(this.onIceCandidate)\n      .then(() => {\n        return this.stream;\n      });\n  }\n\n  multiStream(stream: MediaStream | null) {\n    return this.disconnect()\n      .then(this.createOffer)\n      .then(this.signaling)\n      .then(this.connectPeerConnection)\n      .then(message => {\n        if (typeof this.pc.addStream === 'undefined') {\n          stream.getTracks().forEach(track => {\n            this.pc.addTrack(track, stream);\n          });\n        }\n        else {\n          this.pc.addStream(stream);\n        }\n        if (typeof this.pc.ontrack === 'undefined') {\n          this.pc.onaddstream = event => {\n            if (this.clientId !== event.stream.id) {\n              this.remoteClientIds.push(stream.id);\n              this.callbacks.addstream(event);\n            }\n          };\n        } else {\n          this.pc.ontrack = event => {\n            const stream = event.streams[0];\n            if (!stream) return;\n            if (stream.id === 'default') return;\n            if (stream.id === this.clientId) return;\n            if (-1 < this.remoteClientIds.indexOf(stream.id)) return;\n            event.stream = stream;\n            this.remoteClientIds.push(stream.id);\n            this.callbacks.addstream(event);\n          };\n        }\n        this.pc!.onremovestream = event => {\n          const index = this.remoteClientIds.indexOf(event.stream.id);\n          if (-1 < index) {\n            delete this.remoteClientIds[index];\n          }\n          this.callbacks.removestream(event);\n        };\n        this.stream = stream;\n        return this.setRemoteDescription(message);\n      })\n      .then(this.createAnswer)\n      .then(this.sendAnswer)\n      .then(this.onIceCandidate)\n      .then(() => {\n        return this.stream;\n      });\n  }\n}\n\nexport default ConnectionPublisher;\n","import ConnectionBase from './base';\n\nclass ConnectionSubscriber extends ConnectionBase {\n  connect() {\n    this.role = 'downstream';\n    if (this.options && this.options.multistream) {\n      return this.multiStream();\n    }\n    else {\n      return this.singleStream();\n    }\n  }\n\n  private async singleStream() {\n    await this.disconnect();\n    const offer = await this.createOffer();\n    await this.signaling(offer);\n    \n      .then(this.connectPeerConnection)\n      .then(message => {\n        if (typeof this.pc.ontrack === 'undefined') {\n          this.pc.onaddstream = function(event) {\n            this.stream = event.stream;\n            this.remoteClientIds.push(this.stream.id);\n            this.callbacks.addstream(event);\n          };\n        }\n        else {\n          this.pc.ontrack = function(event) {\n            this.stream = event.streams[0];\n            const streamId = this.stream.id;\n            if (streamId === 'default') return;\n            if (-1 < this.remoteClientIds.indexOf(streamId)) return;\n            event.stream = this.stream;\n            this.remoteClientIds.push(streamId);\n            this.callbacks.addstream(event);\n          };\n        }\n        return this.setRemoteDescription(message);\n      })\n      .then(this.createAnswer)\n      .then(this.sendAnswer)\n      .then(this.onIceCandidate)\n      .then(() => {\n        return this.stream;\n      });\n  }\n\n  multiStream() {\n    return this.disconnect()\n      .then(this.createOffer)\n      .then(this.signaling)\n      .then(this.connectPeerConnection)\n      .then(message => {\n        if (typeof this.pc.ontrack === 'undefined') {\n          this.pc.onaddstream = event => {\n            this.remoteClientIds.push(event.id);\n            this.callbacks.addstream(event);\n          };\n        } else {\n          this.pc.ontrack = event => {\n            const stream = event.streams[0];\n            if (stream.id === 'default') return;\n            if (stream.id === this.clientId) return;\n            if (-1 < this.remoteClientIds.indexOf(stream.id)) return;\n            event.stream = stream;\n            this.remoteClientIds.push(stream.id);\n            this.callbacks.addstream(event);\n          };\n        }\n        this.pc.onremovestream = event => {\n          const index = this.remoteClientIds.indexOf(event.stream.id);\n          if (-1 < index) {\n            delete this.remoteClientIds[index];\n          }\n          this.callbacks.removestream(event);\n        };\n        return this.setRemoteDescription(message);\n      })\n      .then(this.createAnswer)\n      .then(this.sendAnswer)\n      .then(this.onIceCandidate);\n  }\n}\n\nexport default ConnectionSubscriber;\n","import ConnectionPublisher from './connection/publisher';\nimport ConnectionSubscriber from './connection/subscriber';\nimport { ConnectionOptions } from './connection/base';\n\n\nconst Sora = {\n  connection: function(signalingUrl: string, debug: boolean=false) {\n    return new SoraConnection(signalingUrl, debug);\n  }\n};\n\n\nclass SoraConnection {\n  signalingUrl: string;\n  debug: boolean;\n\n  constructor(signalingUrl: string, debug: boolean=false) {\n    this.signalingUrl = signalingUrl;\n    this.debug = debug;\n  }\n\n  publisher(channelId: string, metadata: string, options: ConnectionOptions={ audio: true, video: true }) {\n    return new ConnectionPublisher(this.signalingUrl, channelId, metadata, options, this.debug);\n  }\n\n  subscriber(channelId: string, metadata: string, options: ConnectionOptions={ audio: true, video: true }) {\n    return new ConnectionSubscriber(this.signalingUrl, channelId, metadata, options, this.debug);\n  }\n}\n\nexport default Sora;\n"]}